
  







<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>电解质在写字</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://hawksjamesf.github.io/blog/js/jquery.min.js"></script>
  <script src="https://hawksjamesf.github.io/blog/js/bootstrap.min.js"></script>
  <script src="https://hawksjamesf.github.io/blog/js/header.js"></script>
  <script src="https://hawksjamesf.github.io/blog/js/toc.js"></script>
  <link href="https://hawksjamesf.github.io/blog/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://hawksjamesf.github.io/blog/css/theme.css" rel="stylesheet">
  <link href="https://hawksjamesf.github.io/blog/css/syntax.css" rel="stylesheet">
  <link href="https://hawksjamesf.github.io/blog/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  

  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://hawksjamesf.github.io/blog/">电解质在写字</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://hawksjamesf.github.io/blog/">Home</a></li>
          <li><a href="https://hawksjamesf.github.io/blog/archive.html">Archive</a></li>
          <li><a href="https://hawksjamesf.github.io/blog/tags.html">Tags</a></li>
          <li><a href="https://hawksjamesf.github.io/blog/about.html">About</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">

              <h1>
                <a href="https://hawksjamesf.github.io/blog/2018-01-25/location-system-launch">Location系统 --- 启动流程</a>
              </h1>
              <div class="post-meta">

                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <!-- <time>Thu, 25 Jan 2018 22:50:00 +0000</time> -->
                  <time datetime='2018-01-25'>Thu, Jan 25 2018, 22:50</time>
                  
                </div>

                <!-- <ul> -->
                  <!-- <li>该文章累计文字 :25813</li> -->
                <!-- </ul> -->

                <ul>
                  
                  <li>
                    <a href="https://hawksjamesf.github.io/blog/tag/LBS">LBS</a>
                  </li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <ul id="markdown-toc">
  <li><a href="#1summary" id="markdown-toc-1summary"><em class="header2-font">1.Summary</em></a></li>
  <li><a href="#2about" id="markdown-toc-2about"><em class="header2-font">2.About</em></a></li>
  <li><a href="#3introduction" id="markdown-toc-3introduction"><em class="header2-font">3.Introduction</em></a>    <ul>
      <li><a href="#application层" id="markdown-toc-application层"><em class="header3-font">Application层</em></a></li>
      <li><a href="#framework-java层" id="markdown-toc-framework-java层"><em class="header3-font">Framework-Java层</em></a>        <ul>
          <li><a href="#先来看看gnsslocationprovider" id="markdown-toc-先来看看gnsslocationprovider">先来看看GnssLocationProvider</a></li>
          <li><a href="#再来看看locationproviderproxy" id="markdown-toc-再来看看locationproviderproxy">再来看看LocationProviderProxy</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#4reference" id="markdown-toc-4reference"><em class="header2-font">4.Reference</em></a></li>
</ul>
<h2 id="1summary"><em class="header2-font">1.Summary</em></h2>
<p>  不想写</p>
<h2 id="2about"><em class="header2-font">2.About</em></h2>
<p>  不想写</p>
<h2 id="3introduction"><em class="header2-font">3.Introduction</em></h2>

<p>更新数据的开始都是源于requestLocationUpdates或者requestSingleUpdate接口，那么接下来让我们来看看下面的解析吧。</p>
<h3 id="application层"><em class="header3-font">Application层</em></h3>
<p>  </p>

<p><img src="/blog/asset/2018-01-25/2018-01-25-location-system-launch-api.png" alt="" /></p>

<p>  提供给开发者的接口可以认为两种requestSingleUpdate和requestLocationUpdates，前者获取一次，而或者可以根据大于多少时间再更新，大于多少距离再更新。但是不论差别多大，它们的底层都是调用<code class="highlighter-rouge">requestLocationUpdates(LocationRequest request, LocationListener listener,
            Looper looper, PendingIntent intent)</code>实现的。</p>

<p>frameworks/base/location/java/android/location/LocationManager.java</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">requestLocationUpdates</span><span class="o">(</span><span class="n">LocationRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">LocationListener</span> <span class="n">listener</span><span class="o">,</span>
            <span class="n">Looper</span> <span class="n">looper</span><span class="o">,</span> <span class="n">PendingIntent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">();</span>

        <span class="c1">// wrap the listener class</span>
        <span class="n">ListenerTransport</span> <span class="n">transport</span> <span class="o">=</span> <span class="n">wrapListener</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">looper</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">mService</span><span class="o">.</span><span class="na">requestLocationUpdates</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">transport</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">packageName</span><span class="o">);</span>
       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
       <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  先来说说LocationManagerService，在SystemServer启动的时候调用<code class="highlighter-rouge">ServiceManager.addService(Context.LOCATION_SERVICE, location);</code>注册了LocationManagerService服务，当客户端调用<code class="highlighter-rouge">Context.getSystemService(Context.LOCATION_SERVICE)</code>时，最终LocationManager对象会通过<code class="highlighter-rouge">ServiceManager.getServiceOrThrow(Context.LOCATION_SERVICE);</code> 获得服务端的LocationManagerService对象mService，而接下来LocationManager和LocationManagerService这两者就可以通过binder实现了app进程和framework进程间的通信。</p>

<p>  知道这些我们再来看看LocationManagerService#requestLocationUpdates方法，其注入了四个参数，如下几个。</p>
<ul>
  <li>request: LocationRequest类对象</li>
  <li>transport：ILocationListener类对象</li>
  <li>intent：PendingIntent类对象</li>
  <li>packageName：使用定位功能的应用包名</li>
</ul>

<p>1.LocationRequest类对象</p>

<p>  该类是一个可持久化的Parcelable，为了通过binder到达LocationManagerService，就必须这样做，所以基本可以把它看成一个运输参数的运输车。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">int</span> <span class="n">mQuality</span> <span class="o">=</span> <span class="n">POWER_LOW</span><span class="o">;</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="n">mInterval</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>   <span class="c1">// 60 minutes</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="n">mFastestInterval</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="n">mInterval</span> <span class="o">/</span> <span class="n">FASTEST_INTERVAL_FACTOR</span><span class="o">);</span>  <span class="c1">// 10 minutes</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mExplicitFastestInterval</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="n">mExpireAt</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>  <span class="c1">// no expiry</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">mNumUpdates</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>  <span class="c1">// no expiry</span>
<span class="kd">private</span> <span class="kt">float</span> <span class="n">mSmallestDisplacement</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="o">;</span>    <span class="c1">// meters</span>
<span class="kd">private</span> <span class="n">WorkSource</span> <span class="n">mWorkSource</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mHideFromAppOps</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// True if this request shouldn't be counted by AppOps</span>

<span class="kd">private</span> <span class="n">String</span> <span class="n">mProvider</span> <span class="o">=</span> <span class="n">LocationManager</span><span class="o">.</span><span class="na">FUSED_PROVIDER</span><span class="o">;</span>  <span class="c1">// for deprecated APIs that explicitly request a provider</span>
</code></pre></div></div>
<p>  这些参数的值都是外部调用者提供。见名只意，我们就不做细讲，等在LocationManagerService服务端用到再来将有啥用途。</p>

<p>2.ILocationListener类对象</p>

<p>  该类是客户端用来响应服务端的回调接口。其回调接口如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">android</span><span class="o">.</span><span class="na">location</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.location.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>

<span class="cm">/**
 * {@hide}
 */</span>
<span class="n">oneway</span> <span class="kd">interface</span> <span class="nc">ILocationListener</span>
<span class="o">{</span>
    <span class="kt">void</span> <span class="nf">onLocationChanged</span><span class="o">(</span><span class="n">in</span> <span class="n">Location</span> <span class="n">location</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">onStatusChanged</span><span class="o">(</span><span class="n">String</span> <span class="n">provider</span><span class="o">,</span> <span class="kt">int</span> <span class="n">status</span><span class="o">,</span> <span class="n">in</span> <span class="n">Bundle</span> <span class="n">extras</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">onProviderEnabled</span><span class="o">(</span><span class="n">String</span> <span class="n">provider</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">onProviderDisabled</span><span class="o">(</span><span class="n">String</span> <span class="n">provider</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  每一个LocationListener对象对应着一个响应服务端的ILocationListener对象，通过ILocationListener的回调方法将底层的响应传给实现了LocationListener接口的应用。这里说一下服务端的处理方式，采用锁机制同步处理来至客户端并发下发的请求。</p>

<p>不过有个地方值得我们关注一下。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="n">ListenerTransport</span><span class="o">(</span><span class="n">LocationListener</span> <span class="n">listener</span><span class="o">,</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mListener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mListenerHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">_handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">};</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mListenerHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">_handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">};</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>ILocationListener的实现类ListenerTransport通过外部调用者提供的Looper，来决定handleMessage是在主线程还是在工作线程，这也就意味着允许来自于底层的定位数据可以在在主线程刷新。</p>

<p>3.PendingIntent类对象<br />
  该类用于也是用于获取来自底层的定位数据，不过与ILocationListener不同的是，注册ILocationListener的界面会收到更新的定位数据，而PendingIntent则是将更新的定位数据传给其他的界面。还有一点需要注意的ILocationListener和PendingIntent不能同时存在，请求数据更新时，只能二选一。</p>

<h3 id="framework-java层"><em class="header3-font">Framework-Java层</em></h3>

<p>frameworks/base/services/core/java/com/android/server/LocationManagerService.java</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestLocationUpdates</span><span class="o">(</span><span class="n">LocationRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ILocationListener</span> <span class="n">listener</span><span class="o">,</span>
            <span class="n">PendingIntent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="c1">// providers may use public location API's, need to clear identity</span>
        <span class="kt">long</span> <span class="n">identity</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// We don't check for MODE_IGNORED here; we will do that when we go to deliver</span>
            <span class="c1">// a location.</span>
            <span class="n">checkLocationAccess</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span> <span class="n">allowedResolutionLevel</span><span class="o">);</span>

            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Receiver</span> <span class="n">recevier</span> <span class="o">=</span> <span class="n">checkListenerOrIntentLocked</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">pid</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span>
                        <span class="n">packageName</span><span class="o">,</span> <span class="n">workSource</span><span class="o">,</span> <span class="n">hideFromAppOps</span><span class="o">);</span>
                <span class="n">requestLocationUpdatesLocked</span><span class="o">(</span><span class="n">sanitizedRequest</span><span class="o">,</span> <span class="n">recevier</span><span class="o">,</span> <span class="n">pid</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">packageName</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">identity</span><span class="o">);</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  服务端通过锁机制来处理客户端并发下发请求，所以这样就会导致请求在服务端像队列一样按照顺序被处理，而一个请求对应一个Receiver，Receiver是用来介绍底层上报的定位数据，并回调给客户端。<br />
在锁代码块里面除了创建Receiver还有发送请求的逻辑代码，我们接着往下看。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">requestLocationUpdatesLocked</span><span class="o">(</span><span class="n">LocationRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">Receiver</span> <span class="n">receiver</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">pid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Figure out the provider. Either its explicitly request (legacy use cases), or</span>
        <span class="c1">// use the fused provider</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">request</span> <span class="o">=</span> <span class="n">DEFAULT_LOCATION_REQUEST</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getProvider</span><span class="o">();</span>
    
        <span class="o">...</span>

        <span class="kt">boolean</span> <span class="n">isProviderEnabled</span> <span class="o">=</span> <span class="n">isAllowedByUserSettingsLocked</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isProviderEnabled</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">applyRequirementsLocked</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Notify the listener that updates are currently disabled</span>
            <span class="n">receiver</span><span class="o">.</span><span class="na">callProviderEnabledLocked</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// Update the monitoring here just in case multiple location requests were added to the</span>
        <span class="c1">// same receiver (this request may be high power and the initial might not have been).</span>
        <span class="n">receiver</span><span class="o">.</span><span class="na">updateMonitoring</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>  requestLocationUpdatesLocked方法核心方法就是applyRequirementsLocked方法。为了下面的分析方便，我们这边还需要知道一些背景知识。</p>

<p>1.LocationProviderInterface接口实现类有以下三种：</p>
<ul>
  <li>GnssLocationProvider: 定位数据来源于gps</li>
  <li>LocationProviderProxy：它其实是个proxy，真正的provider是NetworkLocationProvider，该类的实现需要一些服务厂商提供。国内的服务厂商有高德、百度，国外有google等</li>
  <li>PassiveProvider：定位数据来自于其他应用</li>
</ul>

<p>  这三者在启动Location服务时（SystemServer阶段），就通过在systemRunning方法中调用loadProvidersLocked方法初始化了这三个provider。</p>

<p>2.Receiver</p>

<p>  在Receiver类里面有个成员变量mUpdateRecords，是Map类型，用来映射provider和UpdateRecord，即一种provider对应一个UpdateRecord。而对LocationManagerService的成员变量mRecordsByProvider，也是个Map类型，不过是一个provider映射一个UpdateRecord集合。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">private</span> <span class="kd">class</span> <span class="nc">UpdateRecord</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">mProvider</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">LocationRequest</span> <span class="n">mRealRequest</span><span class="o">;</span>  <span class="c1">// original request from client</span>
        <span class="n">LocationRequest</span> <span class="n">mRequest</span><span class="o">;</span>  <span class="c1">// possibly throttled version of the request</span>
        <span class="kd">final</span> <span class="n">Receiver</span> <span class="n">mReceiver</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">mIsForegroundUid</span><span class="o">;</span>
        <span class="n">Location</span> <span class="n">mLastFixBroadcast</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">mLastStatusBroadcast</span><span class="o">;</span>
        <span class="o">...</span>
 <span class="o">}</span>
</code></pre></div></div>
<p>  UpdateRecord用来处理一些请求的变化，比如发送请求的组件不是前台，那么就会让本来要求2分钟间隔更新数据，变成默认要求的半小时，并且将原来的请求节流改成新的请求。</p>

<p>  罗里吧嗦讲完了上面的一些知识，现在终于要来讲最为重要的applyRequirementsLocked方法。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">applyRequirementsLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">provider</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">records</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">UpdateRecord</span> <span class="n">record</span> <span class="o">:</span> <span class="n">records</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">isCurrentProfile</span><span class="o">(</span><span class="n">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">mReceiver</span><span class="o">.</span><span class="na">mIdentity</span><span class="o">.</span><span class="na">mUid</span><span class="o">)))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">checkLocationAccess</span><span class="o">(</span>
                            <span class="n">record</span><span class="o">.</span><span class="na">mReceiver</span><span class="o">.</span><span class="na">mIdentity</span><span class="o">.</span><span class="na">mPid</span><span class="o">,</span>
                            <span class="n">record</span><span class="o">.</span><span class="na">mReceiver</span><span class="o">.</span><span class="na">mIdentity</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span>
                            <span class="n">record</span><span class="o">.</span><span class="na">mReceiver</span><span class="o">.</span><span class="na">mIdentity</span><span class="o">.</span><span class="na">mPackageName</span><span class="o">,</span>
                            <span class="n">record</span><span class="o">.</span><span class="na">mReceiver</span><span class="o">.</span><span class="na">mAllowedResolutionLevel</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">LocationRequest</span> <span class="n">locationRequest</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">mRealRequest</span><span class="o">;</span>
                        <span class="kt">long</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">locationRequest</span><span class="o">.</span><span class="na">getInterval</span><span class="o">();</span>

                        <span class="k">if</span> <span class="o">(!</span><span class="n">isThrottlingExemptLocked</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">mReceiver</span><span class="o">.</span><span class="na">mIdentity</span><span class="o">))</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(!</span><span class="n">record</span><span class="o">.</span><span class="na">mIsForegroundUid</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">interval</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">interval</span><span class="o">,</span> <span class="n">backgroundThrottleInterval</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">locationRequest</span><span class="o">.</span><span class="na">getInterval</span><span class="o">())</span> <span class="o">{</span>
                                <span class="n">locationRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationRequest</span><span class="o">(</span><span class="n">locationRequest</span><span class="o">);</span>
                                <span class="n">locationRequest</span><span class="o">.</span><span class="na">setInterval</span><span class="o">(</span><span class="n">interval</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>

                        <span class="n">record</span><span class="o">.</span><span class="na">mRequest</span> <span class="o">=</span> <span class="n">locationRequest</span><span class="o">;</span>
                        <span class="n">providerRequest</span><span class="o">.</span><span class="na">locationRequests</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">locationRequest</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">interval</span> <span class="o">&lt;</span> <span class="n">providerRequest</span><span class="o">.</span><span class="na">interval</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">providerRequest</span><span class="o">.</span><span class="na">reportLocation</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="n">providerRequest</span><span class="o">.</span><span class="na">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">providerRequest</span><span class="o">.</span><span class="na">reportLocation</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">...</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">...</span>
         <span class="n">p</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="n">providerRequest</span><span class="o">,</span> <span class="n">worksource</span><span class="o">);</span>
    <span class="o">}</span>

</code></pre></div></div>
<p>  在applyRequirementsLocked方法中会先判断请求是在前台发出还是后台发出。<br />
在Android 8.0提出来后台限制的规定，只允许后台应用每小时接收几次位置更新，前台不受影响。上面的代码就是这个限制的实现。如果想了解更多这个限制可以参考这一篇文章<a href="https://developer.android.com/about/versions/oreo/background-location-limits.html">Background Location Limits</a>。然后在判断请求的interval是否小临界值，用一个临界值来限制请求的interval，如果由于频繁就会被流失掉。最后调用LocationProviderInterface#setRequest方法，之前我们已经说过LocationProviderInterface接口的实现类有三个，这里我们挑选GnssLocationProvider和LocationProviderProxy来进行分析。</p>

<h4 id="先来看看gnsslocationprovider">先来看看GnssLocationProvider</h4>

<hr />

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRequest</span><span class="o">(</span><span class="n">ProviderRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sendMessage</span><span class="o">(</span><span class="n">SET_REQUEST</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="n">GpsRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">source</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>  sendMessage方式是对Handler发送消息的包装，GnssLocationProvider的内部类ProviderHandler是在工作线程处理来自其他线程的消息的类，这样可以避免framework主线程因执行太多任务而造成响应慢。我们来继续看看ProviderHandler到底能处理哪些消息。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">message</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">;</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="nl">ENABLE:</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg1</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">handleEnable</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">handleDisable</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">SET_REQUEST:</span>
                    <span class="n">GpsRequest</span> <span class="n">gpsRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">GpsRequest</span><span class="o">)</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">;</span>
                    <span class="n">handleSetRequest</span><span class="o">(</span><span class="n">gpsRequest</span><span class="o">.</span><span class="na">request</span><span class="o">,</span> <span class="n">gpsRequest</span><span class="o">.</span><span class="na">source</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">UPDATE_NETWORK_STATE:</span>
                    <span class="n">handleUpdateNetworkState</span><span class="o">((</span><span class="n">Network</span><span class="o">)</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">REQUEST_SUPL_CONNECTION:</span>
                    <span class="n">handleRequestSuplConnection</span><span class="o">((</span><span class="n">InetAddress</span><span class="o">)</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">RELEASE_SUPL_CONNECTION:</span>
                    <span class="n">handleReleaseSuplConnection</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg1</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">INJECT_NTP_TIME:</span>
                    <span class="n">handleInjectNtpTime</span><span class="o">();</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">DOWNLOAD_XTRA_DATA:</span>
                    <span class="n">handleDownloadXtraData</span><span class="o">();</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">INJECT_NTP_TIME_FINISHED:</span>
                    <span class="n">mInjectNtpTimePending</span> <span class="o">=</span> <span class="n">STATE_IDLE</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">DOWNLOAD_XTRA_DATA_FINISHED:</span>
                    <span class="n">mDownloadXtraDataPending</span> <span class="o">=</span> <span class="n">STATE_IDLE</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">UPDATE_LOCATION:</span>
                    <span class="n">handleUpdateLocation</span><span class="o">((</span><span class="n">Location</span><span class="o">)</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">SUBSCRIPTION_OR_SIM_CHANGED:</span>
                    <span class="n">subscriptionOrSimChanged</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nl">INITIALIZE_HANDLER:</span>
                    <span class="n">handleInitialize</span><span class="o">();</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg2</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// wakelock was taken for this message, release it</span>
                <span class="n">mWakeLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">Log</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"WakeLock released by handleMessage("</span> <span class="o">+</span> <span class="n">messageIdAsString</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                            <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">arg1</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>  ProviderHandler除了能够处理SET_REQUEST消息还能够处理下列消息</p>
<ul>
  <li>GnssLocationProvider初始化的INITIALIZE_HANDLER消息</li>
  <li>SIM卡发生变化的SUBSCRIPTION_OR_SIM_CHANGED消息</li>
  <li>网络可用的UPDATE_NETWORK_STATE消息</li>
  <li>来自底层协议supl的RELEASE_SUPL_CONNECTION释放消息</li>
  <li>请求supl连接的REQUEST_SUPL_CONNECTION连接消息</li>
  <li>注入同步UTC时间的NTP的INJECT_NTP_TIME消息</li>
  <li>下载同AGPS一样功能的XTRA的数据的DOWNLOAD_XTRA_DATA消息</li>
  <li>UPDATE_LOCATION消息</li>
</ul>

<p>对于这么多的消息，这里我们挑INITIALIZE_HANDLER消息来讲一下。<br />
  在GnssLocationProvider的构造时，会发送INITIALIZE_HANDLER消息在工作线程中初始化一些东西，比如gps的一些配置属性；注册广播，注册网络是否可用的监听器<br />
可以从config.xml读取</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c">&lt;!-- Values for GPS configuration --&gt;</span>
    <span class="nt">&lt;string-array</span> <span class="na">translatable=</span><span class="s">"false"</span> <span class="na">name=</span><span class="s">"config_gpsParameters"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>SUPL_HOST=supl.google.com<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>SUPL_PORT=7275<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>NTP_SERVER=north-america.pool.ntp.org<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>SUPL_VER=0x20000<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>SUPL_MODE=1<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>
</code></pre></div></div>
<p>也可以从file（/etc/gps_debug.conf）读取.</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Uncommenting these urls would only enable
#the power up auto injection and force injection(test case).
#XTRA_SERVER_1=http://xtrapath1.izatcloud.net/xtra2.bin
#XTRA_SERVER_2=http://xtrapath2.izatcloud.net/xtra2.bin
#XTRA_SERVER_3=http://xtrapath3.izatcloud.net/xtra2.bin
</span>
<span class="c">#Version check for XTRA
#DISABLE = 0
#AUTO    = 1
#XTRA2   = 2
#XTRA3   = 3
</span><span class="py">XTRA_VERSION_CHECK</span><span class="p">=</span><span class="s">0</span>

<span class="c"># Error Estimate
# _SET = 1
# _CLEAR = 0
</span><span class="py">ERR_ESTIMATE</span><span class="p">=</span><span class="s">0</span>

<span class="c">#Test
</span><span class="py">NTP_SERVER</span><span class="p">=</span><span class="s">time.gpsonextra.net</span>
<span class="c">#Asia
# NTP_SERVER=asia.pool.ntp.org
#Europe
# NTP_SERVER=europe.pool.ntp.org
#North America
# NTP_SERVER=north-america.pool.ntp.org
</span>
<span class="c"># DEBUG LEVELS: 0 - none, 1 - Error, 2 - Warning, 3 - Info
#               4 - Debug, 5 - Verbose
# If DEBUG_LEVEL is commented, Android's logging levels will be used
</span><span class="py">DEBUG_LEVEL</span> <span class="p">=</span> <span class="s">3</span>

<span class="c"># Intermediate position report, 1=enable, 0=disable
</span><span class="py">INTERMEDIATE_POS</span><span class="p">=</span><span class="s">0</span>

<span class="c"># Below bit mask configures how GPS functionalities
# should be locked when user turns off GPS on Settings
# Set bit 0x1 if MO GPS functionalities are to be locked
# Set bit 0x2 if NI GPS functionalities are to be locked
# default - non is locked for backward compatibility
#GPS_LOCK = 0 
</span>
<span class="c"># supl version 1.0
</span><span class="py">SUPL_VER</span><span class="p">=</span><span class="s">0x20000</span>

<span class="c"># Emergency SUPL, 1=enable, 0=disable
</span><span class="py">SUPL_ES</span><span class="p">=</span><span class="s">0</span>

<span class="c">#Choose PDN for Emergency SUPL
#1 - Use emergency PDN
#0 - Use regular SUPL PDN for Emergency SUPL
</span><span class="py">USE_EMERGENCY_PDN_FOR_EMERGENCY_SUPL</span><span class="p">=</span><span class="s">0</span>

<span class="c">#SUPL_MODE is a bit mask set in config.xml per carrier by default.
#If it is uncommented here, this value will overwrite the value from
#config.xml.
#MSA=0X2
#MSB=0X1
</span><span class="py">SUPL_MODE</span><span class="p">=</span><span class="s">3</span>

<span class="c"># GPS Capabilities bit mask
# SCHEDULING = 0x01
# MSB = 0x02
# MSA = 0x04
# ON_DEMAND_TIME = 0x10
# GEOFENCE = 0x20
# default = ON_DEMAND_TIME | MSA | MSB | SCHEDULING | GEOFENCE
</span><span class="py">CAPABILITIES</span><span class="p">=</span><span class="s">0x37</span>

<span class="c"># Accuracy threshold for intermediate positions
# less accurate positions are ignored, 0 for passing all positions
# ACCURACY_THRES=5000
</span>
<span class="c">################################
##### AGPS server settings #####
################################
</span>
<span class="c"># FOR SUPL SUPPORT, set the following
</span><span class="py">SUPL_HOST</span><span class="p">=</span><span class="s">supl.qxwz.com</span>
<span class="py">SUPL_PORT</span><span class="p">=</span><span class="s">7275</span>

<span class="c"># FOR C2K PDE SUPPORT, set the following
# C2K_HOST=c2k.pde.com or IP
# C2K_PORT=1234
</span>
<span class="c"># Bitmask of slots that are available
# for write/install to, where 1s indicate writable,
# and the default value is 0 where no slots
# are writable. For example, AGPS_CERT_WRITABLE_MASK
# of b1000001010 makes 3 slots available
# and the remaining 7 slots unwritable.
#AGPS_CERT_WRITABLE_MASK=0
</span>
<span class="c">####################################
#  LTE Positioning Profile Settings
####################################
# 0: Enable RRLP on LTE(Default)
# 1: Enable LPP_User_Plane on LTE
# 2: Enable LPP_Control_Plane
# 3: Enable both LPP_User_Plane and LPP_Control_Plane
</span><span class="py">LPP_PROFILE</span> <span class="p">=</span> <span class="s">0</span>

<span class="c">################################
# EXTRA SETTINGS
################################
# NMEA provider (1=Modem Processor, 0=Application Processor)
</span><span class="py">NMEA_PROVIDER</span><span class="p">=</span><span class="s">0</span>
<span class="c"># Mark if it is a SGLTE target (1=SGLTE, 0=nonSGLTE)
</span><span class="py">SGLTE_TARGET</span><span class="p">=</span><span class="s">0</span>

<span class="c">##################################################
# Select Positioning Protocol on A-GLONASS system
##################################################
# 0x1: RRC CPlane
# 0x2: RRLP UPlane
# 0x4: LLP Uplane
</span><span class="py">A_GLONASS_POS_PROTOCOL_SELECT</span> <span class="p">=</span> <span class="s">0</span>
</code></pre></div></div>
<p>  看完这一些配置文件，又是一批概念，提供一个文章有空再来看看<a href="https://cdn.rohde-schwarz.com/pws/dl_downloads/dl_common_library/dl_news_from_rs/208/NEWS_208_english_Location_Based_Servives.pdf">Location based services with<br />
GPS, GLONASS, Galileo and OTDOA</a>,主要是讲gps协议层。</p>

<p>  接下来我们继续跟随SET_REQUEST的处理逻辑,最后通过 <code class="highlighter-rouge">startNavigating(singleShot);</code>和<code class="highlighter-rouge"> stopNavigating();</code>控制gps开启关闭，当开启之后，hal层的新数据上报到framework-native层,framework-native层继续上报到framework-java层，而这些回调接口会在哪里被注册了 ？</p>

<p>  当framework-java层中的GnssLocationProvider类初始化时，通过<code class="highlighter-rouge">static { class_init_native(); }</code>代码初始化framework-native层的com_android_server_location_GnssLocationProvider.cpp，初始化的时候保存了framework-java层的回调接口，以供合适的时候上报framework-native层数据给framework-native层。</p>

<p>frameworks/base/services/core/jni/com_android_server_location_GnssLocationProvider.cpp</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">android_location_GnssLocationProvider_class_init_native</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">method_reportLocation</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportLocation"</span><span class="p">,</span>
            <span class="s">"(ZLandroid/location/Location;)V"</span><span class="p">);</span>
    <span class="n">method_reportStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportStatus"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
    <span class="n">method_reportSvStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportSvStatus"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">);</span>
    <span class="n">method_reportAGpsStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportAGpsStatus"</span><span class="p">,</span> <span class="s">"(II[B)V"</span><span class="p">);</span>
    <span class="n">method_reportNmea</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportNmea"</span><span class="p">,</span> <span class="s">"(J)V"</span><span class="p">);</span>
    <span class="n">method_setEngineCapabilities</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"setEngineCapabilities"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
    <span class="n">method_setGnssYearOfHardware</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"setGnssYearOfHardware"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
    <span class="n">method_xtraDownloadRequest</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"xtraDownloadRequest"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">);</span>
    <span class="n">method_reportNiNotification</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportNiNotification"</span><span class="p">,</span>
            <span class="s">"(IIIIILjava/lang/String;Ljava/lang/String;II)V"</span><span class="p">);</span>
    <span class="n">method_requestRefLocation</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"requestRefLocation"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">);</span>
    <span class="n">method_requestSetID</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"requestSetID"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
    <span class="n">method_requestUtcTime</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"requestUtcTime"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">);</span>
    <span class="n">method_reportGeofenceTransition</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportGeofenceTransition"</span><span class="p">,</span>
            <span class="s">"(ILandroid/location/Location;IJ)V"</span><span class="p">);</span>
    <span class="n">method_reportGeofenceStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportGeofenceStatus"</span><span class="p">,</span>
            <span class="s">"(ILandroid/location/Location;)V"</span><span class="p">);</span>
    <span class="n">method_reportGeofenceAddStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportGeofenceAddStatus"</span><span class="p">,</span>
            <span class="s">"(II)V"</span><span class="p">);</span>
    <span class="n">method_reportGeofenceRemoveStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportGeofenceRemoveStatus"</span><span class="p">,</span>
            <span class="s">"(II)V"</span><span class="p">);</span>
    <span class="n">method_reportGeofenceResumeStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportGeofenceResumeStatus"</span><span class="p">,</span>
            <span class="s">"(II)V"</span><span class="p">);</span>
    <span class="n">method_reportGeofencePauseStatus</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">"reportGeofencePauseStatus"</span><span class="p">,</span>
            <span class="s">"(II)V"</span><span class="p">);</span>
    <span class="n">method_reportMeasurementData</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span>
            <span class="n">clazz</span><span class="p">,</span>
            <span class="s">"reportMeasurementData"</span><span class="p">,</span>
            <span class="s">"(Landroid/location/GnssMeasurementsEvent;)V"</span><span class="p">);</span>
    <span class="n">method_reportNavigationMessages</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span>
            <span class="n">clazz</span><span class="p">,</span>
            <span class="s">"reportNavigationMessage"</span><span class="p">,</span>
            <span class="s">"(Landroid/location/GnssNavigationMessage;)V"</span><span class="p">);</span>
    <span class="n">method_reportLocationBatch</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span>
            <span class="n">clazz</span><span class="p">,</span>
            <span class="s">"reportLocationBatch"</span><span class="p">,</span>
            <span class="s">"([Landroid/location/Location;)V"</span><span class="p">);</span>
   <span class="p">...</span>
<span class="p">}</span>

</code></pre></div></div>

<p>有21个回调接口，那么我们需要关注的是这21个回调接口的回调顺序也就是我们常说的生命周期。</p>

<h4 id="再来看看locationproviderproxy">再来看看LocationProviderProxy</h4>

<hr />

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRequest</span><span class="o">(</span><span class="n">ProviderRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mRequest</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
            <span class="n">mWorksource</span> <span class="o">=</span> <span class="n">source</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">ILocationProvider</span> <span class="n">service</span> <span class="o">=</span> <span class="n">getService</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">service</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// never let remote service crash system server</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Exception from "</span> <span class="o">+</span> <span class="n">mServiceWatcher</span><span class="o">.</span><span class="na">getBestPackageName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>在调用setRequest之前，我们需要知道LocationProviderProxy和网络端的连接有个很重要的任务mNewServiceWork。当客户端和网络端连接成功会通过LocationWorkerHandler（用来处理工作线程的任务）执行任务。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="n">Runnable</span> <span class="n">mNewServiceWork</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">D</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"applying state to connected service"</span><span class="o">);</span>

            <span class="kt">boolean</span> <span class="n">enabled</span><span class="o">;</span>
            <span class="n">ProviderProperties</span> <span class="n">properties</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">ProviderRequest</span> <span class="n">request</span><span class="o">;</span>
            <span class="n">WorkSource</span> <span class="n">source</span><span class="o">;</span>
            <span class="n">ILocationProvider</span> <span class="n">service</span><span class="o">;</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">enabled</span> <span class="o">=</span> <span class="n">mEnabled</span><span class="o">;</span>
                <span class="n">request</span> <span class="o">=</span> <span class="n">mRequest</span><span class="o">;</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">mWorksource</span><span class="o">;</span>
                <span class="n">service</span> <span class="o">=</span> <span class="n">getService</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// load properties from provider</span>
                <span class="n">properties</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getProperties</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">properties</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">mServiceWatcher</span><span class="o">.</span><span class="na">getBestPackageName</span><span class="o">()</span> <span class="o">+</span>
                            <span class="s">" has invalid locatino provider properties"</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="c1">// apply current state to new service</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">enabled</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">service</span><span class="o">.</span><span class="na">enable</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">service</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// never let remote service crash system server</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Exception from "</span> <span class="o">+</span> <span class="n">mServiceWatcher</span><span class="o">.</span><span class="na">getBestPackageName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mProperties</span> <span class="o">=</span> <span class="n">properties</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre></div></div>
<p>讲到这里的配置属性我们顺带了解一下ILocationProvider和LocationProvider。</p>

<p>客户端通过LocationManager的getProvider方法获得LocationProvider对象，LocationProvider有个成员变量<code class="highlighter-rouge">ProviderProperties</code>是需要通过binder从服务端的getProviderProperties方法获取，所以存储provider信息的ProviderProperties才是核心。那么服务端的ProviderProperties又是怎么来的呢 ？来自于LocationProviderInterface的子类。</p>

<p>像gps的配置信息，是直接默认初始化，就像这样</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ProviderProperties</span> <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProviderProperties</span><span class="o">(</span>
            <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
            <span class="n">Criteria</span><span class="o">.</span><span class="na">POWER_HIGH</span><span class="o">,</span> <span class="n">Criteria</span><span class="o">.</span><span class="na">ACCURACY_FINE</span><span class="o">);</span>
</code></pre></div></div>
<p>可以看出gps的配置信息是</p>
<ul>
  <li>需要Internet网络（我们常说的互联网，数据传输采用ps）</li>
  <li>需要有卫星</li>
  <li>不需要cellular网络（我们常说的电话通讯网，数据传输采用cs）</li>
  <li>不需要花费monetary</li>
  <li>需要支持上报海拔</li>
  <li>需要支持上报速度</li>
  <li>需要支持上报方位</li>
  <li>需要电量为POWER_HIGH级别</li>
  <li>需要精度为ACCURACY_FINE级别</li>
</ul>

<p>像network的配置信息，是来至ILocationProvider,那么ILocationProvider又是什么 ？在LocationProviderProxy初始化的时候会创建ServiceConnection，ServiceConnection为ServiceConnection接口的实现类，用来连接网络端的provider。Android团队为了给优化网络的定位数据，以及为了让网络定位的服务厂商提供服务，设计了LocationProviderBase类。该类保存了ILocationProvider接口实例化对象，用来响应客户端。</p>

<p>来看个源码感受一下吧。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">LocationProviderBase</span> <span class="o">{</span>
    <span class="o">...</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Service</span> <span class="kd">extends</span> <span class="n">ILocationProvider</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enable</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">onEnable</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disable</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">onDisable</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRequest</span><span class="o">(</span><span class="n">ProviderRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">ws</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">onSetRequest</span><span class="o">(</span><span class="k">new</span> <span class="n">ProviderRequestUnbundled</span><span class="o">(</span><span class="n">request</span><span class="o">),</span> <span class="n">ws</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">ProviderProperties</span> <span class="nf">getProperties</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">mProperties</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getStatus</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">extras</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">onGetStatus</span><span class="o">(</span><span class="n">extras</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getStatusUpdateTime</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">onGetStatusUpdateTime</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">sendExtraCommand</span><span class="o">(</span><span class="n">String</span> <span class="n">command</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">extras</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">onSendExtraCommand</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="n">extras</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dump</span><span class="o">(</span><span class="n">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FastPrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">fd</span><span class="o">));</span>
            <span class="n">onDump</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="n">pw</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
            <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">reportLocation</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">mLocationManager</span><span class="o">.</span><span class="na">reportLocation</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"RemoteException"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// never crash provider, might be running in a system process</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Exception"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">onSetRequest</span><span class="o">(</span><span class="n">ProviderRequestUnbundled</span> <span class="n">request</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">onGetStatus</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">extras</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">long</span> <span class="nf">onGetStatusUpdateTime</span><span class="o">();</span>
<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  一般网络定位服务厂商需要重写LocationProviderBase类一些方法来处理来自客户端的请求，，提供provider的配置属性等等一下东西，还需要提供一个Service类用来连接ServiceWatcher。</p>

<p>  Android团队为了优化定位数据，就是利用这个接口实现了FusedLocation应用。会对来自gps和network的定位数据进行比较，以便获取更加有用的数据。</p>

<p>该应用源码位于framework/base/packages下面</p>

<p><img src="/blog/asset/2018-01-25/2018-01-25-location-system-launch-fusedlocation-app.png" alt="" /></p>

<p>  这里我们可以大致说一下Android团队如何做的。FusedLocationProvider重写了LocationProviderBase提供的方法，并且也提供了自己的配置属性。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ProviderPropertiesUnbundled</span> <span class="n">PROPERTIES</span> <span class="o">=</span> <span class="n">ProviderPropertiesUnbundled</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
            <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">Criteria</span><span class="o">.</span><span class="na">POWER_LOW</span><span class="o">,</span>
            <span class="n">Criteria</span><span class="o">.</span><span class="na">ACCURACY_FINE</span><span class="o">);</span>
</code></pre></div></div>

<p>  可以看出服务端FusedLocation应用能够提供的配置信息是</p>
<ul>
  <li>不需要Internet网络（我们常说的互联网，数据传输采用ps）</li>
  <li>不需要有卫星</li>
  <li>不需要cellular网络（我们常说的电话通讯网，数据传输采用cs）</li>
  <li>不需要花费monetary</li>
  <li>需要支持上报海拔</li>
  <li>需要支持上报速度</li>
  <li>需要支持上报方位</li>
  <li>需要电量为POWER_LOW级别</li>
  <li>需要精度为ACCURACY_FINE级别</li>
</ul>

<p>  然后通过主线程Handler把优化的任务交给了FusionEngine类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="cm">/**
     * Test whether one location (a) is better to use than another (b).
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isBetterThan</span><span class="o">(</span><span class="n">Location</span> <span class="n">locationA</span><span class="o">,</span> <span class="n">Location</span> <span class="n">locationB</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">locationA</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">locationB</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// A provider is better if the reading is sufficiently newer.  Heading</span>
      <span class="c1">// underground can cause GPS to stop reporting fixes.  In this case it's</span>
      <span class="c1">// appropriate to revert to cell, even when its accuracy is less.</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">locationA</span><span class="o">.</span><span class="na">getElapsedRealtimeNanos</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">locationB</span><span class="o">.</span><span class="na">getElapsedRealtimeNanos</span><span class="o">()</span> <span class="o">+</span> <span class="n">SWITCH_ON_FRESHNESS_CLIFF_NS</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// A provider is better if it has better accuracy.  Assuming both readings</span>
      <span class="c1">// are fresh (and by that accurate), choose the one with the smaller</span>
      <span class="c1">// accuracy circle.</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">locationA</span><span class="o">.</span><span class="na">hasAccuracy</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">locationB</span><span class="o">.</span><span class="na">hasAccuracy</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">locationA</span><span class="o">.</span><span class="na">getAccuracy</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">locationB</span><span class="o">.</span><span class="na">getAccuracy</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>这个就是优化的算法。</p>

<p>  接着回到ILocationProvider的setRequest方法调用，这下我们就可以轻松的知道LocationProviderProxy通过binder将请求发送给网络端的服务，而网络端的ILocationProvider接口就是接受者。</p>
<h2 id="4reference"><em class="header2-font">4.Reference</em></h2>
<p>Android Open Source Project</p>


                <!-- donation -->
                <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                  <div>如果您觉得写得还不错或者对您有所启发，那就赶紧动动您的小指头，点击下面的红色按钮，狠狠地打赏一番吧。
                  </div>
                  <br/>
                  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                    <span>赏</span>
                  </button>
                  <div id="QR" style="display: none;">

                    <div id="wechat" style="display: inline-block">
                      <img id="wechat_qr" src="/blog/asset/donation-wechat.jpg" alt="hawks jamesf WeChat Pay" />
                      <p>微信打赏</p>
                    </div>

                    <div id="alipay" style="display: inline-block">
                      <img id="alipay_qr" src="/blog/asset/donation-alipay.png" alt="hawks jamesf Alipay" />
                      <p>支付宝打赏</p>
                    </div>
                  </div>
                </div>

                

<div class="share-bar">
  <ul class="share-buttons">
    
    <li class="share-facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://hawksjamesf.github.io/2018-01-25/location-system-launch" target="_blank" title="Share on Facebook">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-facebook fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-twitter">
      <a href="https://twitter.com/intent/tweet?url=https://hawksjamesf.github.io/2018-01-25/location-system-launch&text=Location系统 --- 启动流程" target="_blank" title="Tweet">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-twitter fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    

    
    <li class="share-linkedin">
      <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://hawksjamesf.github.io/2018-01-25/location-system-launch&title=Location系统 --- 启动流程&summary=讲解启动流程&source=" target="_blank" title="Share on LinkedIn">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-linkedin fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    

    
    <li class="share-envelope">
      <a href="mailto:?&subject=Location系统 --- 启动流程&body=讲解启动流程 https://hawksjamesf.github.io/2018-01-25/location-system-launch" target="_blank" title="Email">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-envelope-o fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

  </ul>
</div>


              </div>

              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the
                  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by
                  <span class="logo-disqus">Disqus</span>
                </a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li>
      <a href="/blog/2018-09-22/gdd-summary">初次参加Google Developer Days</a>
    </li>
    
    <li>
      <a href="/blog/2018-07-24/shared-android-system-intro">Android 系统入门分享</a>
    </li>
    
    <li>
      <a href="/blog/2018-07-22/elementary-mind-kotlin">初入Kotlin</a>
    </li>
    
    <li>
      <a href="/blog/2018-04-03/network-retrofit-elementary">网络 --- Retrofit的使用</a>
    </li>
    
    <li>
      <a href="/blog/2018-03-23/application-window-foreword">这些Window们 --- 前言</a>
    </li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul class="sideBarTags">
    <!-- 
      <li><a href="/blog/tag/呓语">呓语</a></li>
      
    
      <li><a href="/blog/tag/基础知识">基础知识</a></li>
      
    
      <li><a href="/blog/tag/Tools">Tools</a></li>
      
    
      <li><a href="/blog/tag/逆向工程">逆向工程</a></li>
      
    
      <li><a href="/blog/tag/Build Tools">Build Tools</a></li>
      
    
      <li><a href="/blog/tag/AI">AI</a></li>
      
    
      <li><a href="/blog/tag/React Native">React Native</a></li>
      
    
      <li><a href="/blog/tag/FileDownloader">FileDownloader</a></li>
      
    
      <li><a href="/blog/tag/Android Senior Engineer">Android Senior Engineer</a></li>
      
    
      <li><a href="/blog/tag/LBS">LBS</a></li>
      
    
      <li><a href="/blog/tag/Android Architecture">Android Architecture</a></li>
      
    
      <li><a href="/blog/tag/分享">分享</a></li>
      
     -->

     
    <li>
      <a href="/blog/tag/AI" data-toggle="tooltip" data-placement="right" title="2">
        <span>AI</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/Android%20Architecture" data-toggle="tooltip" data-placement="right" title="1">
        <span>Android Architecture</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/Android%20Senior%20Engineer" data-toggle="tooltip" data-placement="right" title="12">
        <span>Android Senior Engineer</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/Build%20Tools" data-toggle="tooltip" data-placement="right" title="3">
        <span>Build Tools</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/FileDownloader" data-toggle="tooltip" data-placement="right" title="2">
        <span>FileDownloader</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/LBS" data-toggle="tooltip" data-placement="right" title="6">
        <span>LBS</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/React%20Native" data-toggle="tooltip" data-placement="right" title="1">
        <span>React Native</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/Tools" data-toggle="tooltip" data-placement="right" title="2">
        <span>Tools</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/%E5%88%86%E4%BA%AB" data-toggle="tooltip" data-placement="right" title="1">
        <span>分享</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/%E5%91%93%E8%AF%AD" data-toggle="tooltip" data-placement="right" title="3">
        <span>呓语</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86" data-toggle="tooltip" data-placement="right" title="5">
        <span>基础知识</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/tag/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B" data-toggle="tooltip" data-placement="right" title="1">
        <span>逆向工程</span>
      </a>
    </li>
    
  </ul>
</div>
        </div>
      </div>
    </div>



    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'HawksJamesf'; // required: replace example with your forum shortname
  var disqus_identifier = "/2018-01-25/location-system-launch";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Hawks Jamesf &copy; 2016</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="HawksJamesf on Github" href="https://github.com/HawksJamesf" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="6393208/hawks93jf on StackOverflow" href="http://stackoverflow.com/users/6393208/hawks93jf" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="/blog/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  
  
   
    <li>
      <a title="wei-zhi-end zhihu" href="https://www.zhihu.com/people/wei-zhi-end " target="_blank">
        <!-- <span class="fa-stack fa-lg"> -->
          <!-- <i class="fa   fa-inverse  fa-2x">知</i> -->
          <i class="fa   fa-stop-circle  fa-2x">知</i>
          <!-- <i class="fa fa-check-circle fa-2x"></i> -->
          <!-- <i class="fa fa-stack-1x fa-circle-o"></i> -->
        <!-- </span> -->
      </a>
    </li>
  
  
    <li>
      <a title="weizhiend weibo" href="http://weibo.com/weizhiend " target="_blank"><i class="fa fa-weibo fa-2x"></i></a>
    </li>
  

  
  <li>
    <a title="weizhiend douban" href="https://www.douban.com/people/weizhiend " target="_blank">
      <!-- <span class="fa-stack fa-lg"> -->
        <!-- <i class="fa   fa-inverse  fa-2x">知</i> -->
        <i class="fa   fa-stop-circle  fa-2x">豆</i>
        <!-- <i class="fa fa-check-circle fa-2x"></i> -->
        <!-- <i class="fa fa-stack-1x fa-circle-o"></i> -->
      <!-- </span> -->
    </a>
  </li>


</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>